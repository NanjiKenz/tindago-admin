# Payment System Quick Reference\n\n## 🎯 What Was Built\n\n### Backend (tindago-admin)\n✅ **Invoice Creation API** - Already existed\n- Endpoint: `POST /api/payments/invoice`\n- Creates Xendit invoice, calculates commission, saves ledger draft\n- Returns: invoiceId, invoiceUrl, commission breakdown\n\n✅ **Webhook Handler** - ENHANCED with wallet crediting\n- Endpoint: `POST /api/webhooks/xendit`\n- Verifies Xendit callback token\n- Updates ledger status to PAID/SETTLED\n- **NEW**: Credits wallets/{storeId}.available with storeAmount\n- **NEW**: Records wallet transaction for audit\n- Handles idempotency to prevent double-crediting\n\n### Mobile App (TindaGo)\n✅ **Earnings Dashboard** - NEW\n- Shows: Total Earned, This Month, Pending, Available\n- Location: `app/(main)/(store-owner)/earnings/index.tsx`\n- Real-time updates from Firebase\n\n✅ **Transactions History** - NEW\n- Lists all payments with commission breakdown\n- Filterable by status\n- Location: `app/(main)/(store-owner)/earnings/transactions.tsx`\n\n✅ **Wallet Overview** - UPDATED\n- Shows available balance and quick actions\n- Location: `app/(main)/(store-owner)/wallet.tsx`\n\n✅ **Payout Request Form** - NEW\n- Validate amount, select method, enter account details\n- Location: `app/(main)/(store-owner)/wallet/payout-request.tsx`\n\n✅ **Payout History** - NEW\n- Track all payout requests with status\n- Location: `app/(main)/(store-owner)/wallet/payout-history.tsx`\n\n✅ **Payment Flow** - ALREADY CORRECT\n- Already calls admin invoice API (no Xendit SDK from mobile)\n- Location: `app/(main)/(customer)/payment.tsx`\n\n---\n\n## 🔑 Key Code Locations\n\n### Wallet Crediting Logic (NEW)\n**File**: `tindago-admin/src/app/api/webhooks/xendit/route.ts` (lines 49-74)\n```typescript\nif (status === 'PAID' || status === 'SETTLED') {\n  const storeAmount = roundCurrency(metadata.store_amount || (amount - (metadata.commission || 0)));\n  const walletRef = ref(database, `wallets/${storeId}`);\n  const walletSnap = await get(walletRef);\n  const currentBalance = walletSnap.exists() ? (walletSnap.val().available || 0) : 0;\n  const newBalance = roundCurrency(currentBalance + storeAmount);\n  \n  // Update wallet\n  await update(walletRef, {\n    available: newBalance,\n    updatedAt: new Date().toISOString(),\n  });\n  \n  // Record transaction\n  await set(ref(database, `wallets/${storeId}/transactions/${txnId}`), {\n    type: 'credit',\n    amount: storeAmount,\n    invoiceId,\n    orderNumber,\n    relatedStatus: status,\n    createdAt: new Date().toISOString(),\n  });\n}\n```\n\n### Earnings Dashboard Data Fetch\n**File**: `TindaGo/app/(main)/(store-owner)/earnings/index.tsx` (lines 59-81)\n- Fetches `wallets/{storeId}` for available balance\n- Fetches `ledgers/stores/{storeId}/transactions` for stats\n- Calculates: totalEarned (PAID/SETTLED), thisMonth, pending (PENDING)\n\n### Store ID Access\n**File**: `TindaGo/src/contexts/UserContext.tsx`\n- For store owners: `user.id === user.storeId`\n- Added `storeId?: string` field for clarity\n\n---\n\n## 🧪 How to Test\n\n### 1. Create a Test Invoice\n```bash\ncurl -X POST http://localhost:3000/api/payments/invoice \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"orderNumber\": \"TEST-001\",\n    \"total\": 1000,\n    \"method\": \"gcash\",\n    \"store\": {\"id\": \"store123\", \"name\": \"Test Store\"},\n    \"customer\": {\"email\": \"test@example.com\", \"name\": \"Test Customer\", \"phone\": \"09123456789\"},\n    \"items\": [{\"name\": \"Item 1\", \"quantity\": 1, \"price\": 1000}]\n  }'\n```\n\n### 2. Simulate Payment in Xendit Test Mode\n- Open the returned `invoiceUrl` in browser\n- Use Xendit test payment method to complete payment\n\n### 3. Verify Webhook Processed\n- Check Firebase `processed_webhooks/{invoiceId}` exists\n- Check `orders/{orderId}.paymentStatus === 'paid'`\n- Check `ledgers/stores/store123/transactions/{invoiceId}.status === 'PAID'`\n\n### 4. Verify Wallet Credited\n- Check Firebase `wallets/store123.available > 0`\n- Check `wallets/store123/transactions/WALLET-{invoiceId}` exists\n\n### 5. Check Mobile App\n- Store owner opens TindaGo app\n- Goes to Earnings → should see transaction\n- Goes to Wallet → should see updated available balance\n\n---\n\n## 📊 Data Flow Diagram\n\n```\n┌─────────────────┐\n│ Customer        │\n│ payment.tsx     │\n└────────┬────────┘\n         │ POST /api/payments/invoice\n         ▼\n┌─────────────────────────────────────┐\n│ tindago-admin                       │\n│ /api/payments/invoice               │\n│ - Calculate commission              │\n│ - Create Xendit invoice             │\n│ - Save ledger draft (PENDING)       │\n└────────┬────────────────────────────┘\n         │ Returns invoiceUrl\n         ▼\n┌─────────────────┐\n│ Xendit          │\n│ Payment Page    │\n└────────┬────────┘\n         │ Customer pays\n         ▼\n┌─────────────────────────────────────┐\n│ Xendit Webhook                      │\n│ POST /api/webhooks/xendit           │\n│ - Verify token                      │\n│ - Check idempotency                 │\n│ - Update ledger → PAID              │\n│ - Update order → paymentStatus paid │\n│ - Credit wallet → +storeAmount      │\n│ - Record wallet txn                 │\n└────────┬────────────────────────────┘\n         │\n         ▼\n┌─────────────────────────────────────┐\n│ Firebase Realtime DB                │\n│ - wallets/{storeId}.available       │\n│ - ledgers/stores/{storeId}/txns     │\n│ - orders/{orderId}.paymentStatus    │\n└────────┬────────────────────────────┘\n         │ Listener triggers\n         ▼\n┌─────────────────┐\n│ Store Owner     │\n│ TindaGo App     │\n│ - Earnings UI   │\n│ - Wallet UI     │\n│ - Sees updates  │\n└─────────────────┘\n```\n\n---\n\n## 🔒 Security Checklist\n\n- ✅ No Xendit secret keys in mobile code\n- ✅ All payments go through admin API\n- ✅ Webhook verifies Xendit callback token\n- ✅ Idempotency prevents duplicate transactions\n- ⏳ Firebase security rules restrict data access (TO DO)\n- ✅ Commission rates stored server-side\n- ✅ Wallet updates only via webhook (not mobile API)\n\n---\n\n## 💾 Firebase Paths\n\n### Read by Store Owner\n- `ledgers/stores/{storeId}/transactions/*` - Their transactions\n- `wallets/{storeId}` - Their balance\n- `payouts/{payoutId}` - Their payout requests (filter by storeId)\n\n### Written by Admin/Server Only\n- `ledgers/stores/{storeId}/transactions/{invoiceId}` - Webhook updates\n- `wallets/{storeId}` - Webhook credits\n- `orders/{orderId}.paymentStatus` - Webhook updates\n- `processed_webhooks/{invoiceId}` - Idempotency marker\n\n### Written by Store Owner\n- `payouts/{payoutId}` - Submit payout request\n\n---\n\n## 🐛 Debugging\n\n### Payment shows PENDING but not updating\n1. Check webhook logs in tindago-admin\n2. Verify `XENDIT_WEBHOOK_TOKEN` matches in Xendit dashboard\n3. Check `processed_webhooks/{invoiceId}` exists (idempotency marker)\n4. Verify storeId in metadata matches\n\n### Wallet not credited\n1. Check ledger transaction has `status === 'PAID'` or `'SETTLED'`\n2. Check `wallets/{storeId}` exists (may need to create manually first)\n3. Check `wallets/{storeId}/available` increased\n4. Check `wallets/{storeId}/transactions/WALLET-*` created\n\n### Mobile not showing earnings\n1. Verify user.storeId is set in UserContext\n2. Check Firebase security rules allow read from storeId\n3. Check `ledgers/stores/{storeId}/transactions` path has data\n4. Check app has Firebase read permission for paths\n5. Verify real-time listener is registered (check console logs)\n\n---\n\n## 📝 Commission Math\n\n```\nTotal Amount: 1000\nCommission Rate: 5% (0.05)\nCommission: 1000 × 0.05 = 50\nStore Amount: 1000 - 50 = 950\n\nWallet Increase: +950\n```\n\n**Xendit fees already deducted from commission** (configured in invoice creation)\n\n---\n\n## 🚀 Deployment Checklist\n\n- [ ] Set `XENDIT_MODE=live` in production\n- [ ] Update `XENDIT_SECRET_KEY` and `XENDIT_PUBLIC_KEY` to live keys\n- [ ] Verify webhook URL is production domain\n- [ ] Configure Firebase security rules\n- [ ] Test end-to-end with test payment first\n- [ ] Monitor webhook logs for errors\n- [ ] Have rollback plan if needed\n\n---\n\n## 📞 API Endpoints\n\n### Create Invoice\n```\nPOST /api/payments/invoice\nContent-Type: application/json\n\n{\n  \"orderNumber\": \"ORD-2024-123\",\n  \"total\": 1000,\n  \"method\": \"gcash\",\n  \"store\": {\"id\": \"store123\", \"name\": \"My Store\"},\n  \"customer\": {\"email\": \"buyer@example.com\", \"name\": \"John\", \"phone\": \"09123456789\"},\n  \"items\": [{\"name\": \"Product\", \"quantity\": 1, \"price\": 1000}]\n}\n\nResponse:\n{\n  \"success\": true,\n  \"invoiceId\": \"inv_xxx\",\n  \"invoiceUrl\": \"https://xendit.co/web/invoices/...\",\n  \"commission\": 50,\n  \"storeAmount\": 950,\n  \"expiryDate\": \"2024-01-16T10:00:00Z\"\n}\n```\n\n### Webhook (Xendit → Your Server)\n```\nPOST /api/webhooks/xendit\nX-Callback-Token: webhook_token_xxx\nContent-Type: application/json\n\n{\n  \"id\": \"inv_xxx\",\n  \"status\": \"PAID\",\n  \"amount\": 1000,\n  \"paid_at\": \"2024-01-15T10:05:00Z\",\n  \"payment_method\": \"GCASH\",\n  \"metadata\": {\n    \"order_number\": \"ORD-2024-123\",\n    \"store_id\": \"store123\",\n    \"commission\": 50,\n    \"store_amount\": 950\n  }\n}\n\nResponse: {\"ok\": true}\n```\n\n---\n\n## ✨ What's Next\n\n1. Deploy Firebase security rules\n2. Execute end-to-end payment test\n3. Monitor webhook logs\n4. Get admin approval workflow running\n5. Launch to production\n"